machine:
  node:
    version: 6.3.0
dependencies:
  cache_directories:
    - "node_modules"
    - "~/.npm"
    - "~/.meteor"
    - $(npm config get prefix)/lib/node_modules
  override:
    - PATH=$PATH:$HOME/.meteor
    - if [ -d ~/.meteor ]; then sudo ln -s ~/.meteor/meteor /usr/local/bin/meteor; fi
    - if [ ! -e $HOME/.meteor/meteor ]; then curl https://install.meteor.com | sh; fi
    - meteor update
    - meteor npm install
    - sudo apt-get install -y locales grep
    - sudo locale-gen en_US.UTF-8
    - sudo localedef -i en_GB -f UTF-8 en_US.UTF-8
    - sudo dpkg-reconfigure locales
    - sudo sh -c "echo -e 'LANG=en_US.UTF-8\nLC_ALL=en_US.UTF-8' > /etc/default/locale" 
    - export LANG=C
    - npm install -g chimp
    - mkdir empty
    - chimp --browser=phantomjs --path empty
   
test:
  override:
    - npm run unit-ci
    - npm install -g codeclimate-test-reporter
    - CODECLIMATE_REPO_TOKEN=e0b43cf94dece3dadef8107adf1da0a5baf2281ac7ba164a1571f35c28fa71dc codeclimate-test-reporter < .coverage/lcov.info 
    - meteor:
        background: true
    - until curl --max-time 300 http://localhost:3000/; do sleep 1; done
    - npm run acceptance-ci
    